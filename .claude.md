# Claude AI Assistant Context for KumoCMS Terraform Module

## Project Overview

This is the **terraform-aws-kumocms-regional** module, a professional-grade Terraform module for deploying KumoCMS (Cloud-based Content Management System) regional infrastructure on AWS.

## Project Purpose

KumoCMS provides a serverless, multi-region document management system with:
- S3-based document storage with versioning
- DynamoDB metadata storage with Global Tables support
- Lambda-based API handlers (Python 3.12)
- REST API via API Gateway
- Optional event-driven metadata extraction
- Dual authentication support (API Key or AWS Cognito)

## Architecture Components

### Core Services
1. **S3 Bucket**: Document storage with encryption, versioning, lifecycle policies
2. **DynamoDB Table**: Metadata storage (provided externally, referenced by name)
3. **Lambda Functions**:
   - `api_handler`: Main API operations (upload, retrieve, replace, delete, archive, restore)
   - `authorizer`: Custom API key validator (optional, API key auth only)
   - `event_processor`: Metadata extraction (optional, event-driven mode)
4. **API Gateway**: REST API with REGIONAL or PRIVATE endpoints
5. **Cognito User Pool**: Optional JWT-based authentication
6. **EventBridge**: Optional automated metadata extraction on upload
7. **CloudWatch**: Centralized logging with 14-day retention
8. **SQS**: Dead Letter Queue for failed Lambda invocations

### Deployment Modes

#### Admin vs Power User
- **Admin Mode** (`create_iam_roles = true`): Module creates all IAM roles
- **Power User Mode** (`create_iam_roles = false`): Uses pre-created IAM roles (for restricted permissions)

#### Public vs Private API
- **REGIONAL** (Public): Internet-accessible API Gateway
- **PRIVATE**: VPC-only access via VPC endpoint
  - Admin: Creates VPC endpoint with security group
  - Power User: Uses pre-created VPC endpoint

#### Authentication Methods
- **API Key** (`auth_method = "api_key"`): Lambda authorizer validates keys from Secrets Manager
- **Cognito** (`auth_method = "cognito"`): AWS Cognito User Pool with JWT tokens
  - Can create new User Pool (`create_cognito_user_pool = true`)
  - Or use existing User Pool (provide `cognito_user_pool_arn`)

## File Structure

```
terraform-aws-kumocms-regional/
├── versions.tf           # Terraform and provider requirements
├── variables.tf          # Input variables (40+ parameters)
├── locals.tf             # Computed local values and conditional logic
├── s3.tf                 # S3 bucket with encryption and lifecycle
├── iam.tf                # IAM roles and policies (conditional)
├── lambda.tf             # Lambda functions (api_handler, authorizer, event_processor)
├── api_gateway.tf        # REST API with endpoints and authorizers
├── cognito.tf            # Optional Cognito User Pool
├── eventbridge.tf        # Optional EventBridge rules
├── cloudwatch.tf         # CloudWatch Log Groups
├── sqs.tf                # Dead Letter Queue
├── vpc_endpoint.tf       # VPC endpoint for private API
├── waf.tf                # Optional WAF association
├── outputs.tf            # Module outputs
├── README.md             # Comprehensive documentation
└── IAM_POLICY_EXAMPLES.md # IAM policy examples for power users
```

## Key Design Patterns

### Conditional Resource Creation
Resources use `count` for conditional creation based on:
- `var.create_iam_roles` - IAM role management
- `var.enable_eventbridge_metadata_extraction` - Event-driven features
- `var.enable_dlq` - Dead Letter Queue
- `var.auth_method` - Authentication method selection
- `var.create_cognito_user_pool` - Cognito User Pool creation
- `var.api_gateway_endpoint_type` - Public/Private API mode

### Local Variable Logic
`locals.tf` contains computed values that determine:
- Which IAM role ARNs to use (created or provided)
- Which VPC endpoint to use (created or provided)
- Which authorizer to use (API key or Cognito)
- Which Cognito User Pool ARN to use (created or provided)

### Resource Naming Convention
All resources use consistent naming: `${local.resource_prefix}-<resource-type>`
- `resource_prefix = "${var.project_name}-${var.environment}"`
- Example: `kumocms-prod-api-handler`

## API Endpoints

Explicit endpoints defined in `api_gateway.tf`:
- `GET /healthcheck` - Health check (no auth)
- `GET /documents` - List documents
- `POST /documents` - Upload document
- `GET /documents/{id}` - Retrieve document
- `PUT /documents/{id}` - Replace document
- `DELETE /documents/{id}` - Delete document
- `POST /documents/{id}/archive` - Archive document
- `POST /documents/{id}/restore` - Restore document
- `ANY /{proxy+}` - Catch-all proxy for additional routes

CORS enabled for all endpoints except healthcheck.

## Lambda Source Code

Lambda functions expect deployment package from [kumocms-lambda-python](https://github.com/kumocms/kumocms-lambda-python):
- Handler locations:
  - API: `src.handlers.api.main.lambda_handler`
  - Authorizer: `src.handlers.auth_validator.lambda_handler`
  - Event Processor: `src.handlers.event_processor.lambda_handler`

## Important Considerations

### Security
- All S3 buckets have public access blocked
- Encryption at rest enabled by default (AES256)
- Least-privilege IAM roles
- Optional WAF for threat protection
- Deletion protection for Cognito User Pools

### Cost Optimization
- CloudWatch Logs: 14-day retention
- S3 Lifecycle rules: Customizable per deployment
- DLQ message retention: 14 days

### Multi-Region Support
- DynamoDB Global Tables: Use same table name across regions
- S3 buckets: Unique names per region
- Regional API endpoints

## Common Tasks for AI Assistant

### When User Asks to Modify Code
1. Check if change affects conditional resources
2. Update related locals if needed
3. Consider impact on both admin and power user modes
4. Verify outputs are updated if new resources added
5. Update README.md if user-facing changes

### When User Reports Issues
1. Check variable validation rules
2. Verify conditional logic in locals.tf
3. Look for missing dependencies in resource definitions
4. Check IAM permissions in iam.tf

### When Adding New Features
1. Add variables with descriptions and defaults
2. Update locals.tf if conditional logic needed
3. Create/update relevant .tf file
4. Add outputs for new resources
5. Update README.md with examples
6. Consider impact on existing deployments

## Code Quality Standards

- **Headers**: All .tf files include copyright and SPDX license identifier
- **Comments**: Section headers with descriptive context
- **Formatting**: Consistent indentation, spacing, and organization
- **Naming**: Clear, descriptive resource and variable names
- **Documentation**: Inline comments for complex logic
- **Validation**: Input validation for critical variables
- **Tags**: All resources include common_tags for cost allocation

## Testing Considerations

Users should test:
1. Admin mode with IAM role creation
2. Power user mode with pre-created roles
3. Public API (REGIONAL endpoint)
4. Private API (VPC endpoint)
5. API Key authentication
6. Cognito authentication (with new and existing pools)
7. Optional features (EventBridge, DLQ, WAF)
8. Multi-region deployment

## Related Repositories

- **kumocms-lambda-python**: Lambda function source code
- **kumocms.github.io**: Project documentation and architecture diagrams
- **terraform-aws-kumocms-regional**: This module (regional deployment)

## License

MIT License - See LICENSE file

---

When assisting with this project, maintain the professional quality, comprehensive documentation, and flexible design patterns established throughout the codebase.
