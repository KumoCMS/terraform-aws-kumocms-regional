# Gemini AI Assistant Context for KumoCMS Terraform Module

## Project Identity

**Name**: terraform-aws-kumocms-regional  
**Type**: Terraform Infrastructure Module  
**Target Platform**: Amazon Web Services (AWS)  
**Language**: HashiCorp Configuration Language (HCL)  
**License**: MIT  

## Mission Statement

Deploy production-ready, serverless document management infrastructure on AWS with maximum flexibility for different organizational security models and deployment scenarios.

## Core Functionality

This Terraform module provisions regional infrastructure for **KumoCMS** (Kubernetes-style Managed Object Content Management System), enabling:

- **Document Storage**: S3-based with versioning, encryption, and lifecycle management
- **Metadata Management**: DynamoDB for searchable document metadata
- **API Layer**: REST API via API Gateway with Lambda integration
- **Authentication**: Dual-mode support (API Key or AWS Cognito JWT)
- **Event Processing**: Optional automated metadata extraction on upload
- **Multi-Region**: Designed for active-active deployments across AWS regions

## Technical Architecture

### Infrastructure Stack

```
┌─────────────────────────────────────────────────────────────┐
│                     API Gateway (REST)                       │
│              (REGIONAL or PRIVATE endpoint)                  │
│           Authorizer: Lambda Custom OR Cognito               │
└────────────────────────────┬────────────────────────────────┘
                             │
                    ┌────────┴─────────┐
                    │                  │
         ┌──────────▼─────────┐  ┌────▼──────────────────┐
         │  Lambda: API       │  │ Lambda: Authorizer    │
         │  Handler           │  │ (API Key only)        │
         │  - Upload          │  └───────────────────────┘
         │  - Retrieve        │
         │  - Delete          │         ┌────────────────────┐
         │  - Replace         │         │ Cognito User Pool  │
         │  - Archive         │         │ (Optional)         │
         │  - Restore         │         └────────────────────┘
         └──────────┬─────────┘
                    │
         ┌──────────┼─────────────────┐
         │          │                 │
    ┌────▼───┐  ┌──▼─────────┐  ┌───▼────────┐
    │   S3   │  │  DynamoDB  │  │ Secrets    │
    │ Bucket │  │   Table    │  │ Manager    │
    └────┬───┘  └────────────┘  └────────────┘
         │
         │ (Optional Event Notification)
         │
    ┌────▼──────────┐
    │  EventBridge  │
    │     Rule      │
    └────┬──────────┘
         │
    ┌────▼─────────────────┐
    │ Lambda: Event        │
    │ Processor            │
    │ - Extract metadata   │
    │ - Update DynamoDB    │
    └──────────────────────┘
```

### Deployment Flexibility Matrix

| Dimension | Options | Implementation |
|-----------|---------|----------------|
| IAM Management | Admin / Power User | `create_iam_roles` flag |
| API Accessibility | Public / Private | `api_gateway_endpoint_type` |
| VPC Endpoint | Create / Use Existing | `create_vpc_endpoint` flag |
| Authentication | API Key / Cognito | `auth_method` variable |
| Cognito Pool | Create / Use Existing | `create_cognito_user_pool` flag |
| Event Processing | Enabled / Disabled | `enable_eventbridge_metadata_extraction` |
| Dead Letter Queue | Enabled / Disabled | `enable_dlq` flag |
| WAF Protection | Enabled / Disabled | `enable_waf` flag |

## File Organization

### Primary Configuration Files

1. **versions.tf** - Terraform and provider constraints
2. **variables.tf** - 40+ input parameters with validation
3. **locals.tf** - Conditional logic and computed values
4. **outputs.tf** - Exported values for consumption

### Service-Specific Files

- **s3.tf** - Document storage bucket configuration
- **iam.tf** - Role and policy definitions (conditional)
- **lambda.tf** - Function definitions (3 functions, conditional)
- **api_gateway.tf** - REST API with 8+ explicit endpoints
- **cognito.tf** - User pool, client, domain (optional)
- **eventbridge.tf** - Event rules and targets (optional)
- **cloudwatch.tf** - Log groups for all Lambda functions
- **sqs.tf** - Dead Letter Queue (optional)
- **vpc_endpoint.tf** - Private API access (conditional)
- **waf.tf** - Web Application Firewall association (optional)

## Variable Categories

### Required Variables
- `environment`: Deployment environment (dev/staging/prod)
- `aws_region`: Target AWS region
- `lambda_deployment_package_path`: Path to Lambda ZIP
- `s3_bucket_name`: Globally unique S3 bucket name
- `dynamodb_table_name`: DynamoDB table for metadata
- `api_authorizer_secrets_arn`: Secrets Manager ARN (API key mode)

### Authentication Configuration
- `auth_method`: "api_key" or "cognito"
- `create_cognito_user_pool`: Create new or use existing
- `cognito_user_pool_arn`: Existing pool ARN (if applicable)
- `cognito_password_min_length`: Password policy (default: 8)
- `cognito_mfa_configuration`: OFF/ON/OPTIONAL
- `cognito_callback_urls`: OAuth callback URLs
- `cognito_domain_prefix`: Hosted UI domain

### Network Configuration
- `api_gateway_endpoint_type`: REGIONAL or PRIVATE
- `vpc_id`: VPC for private API (conditional)
- `subnet_ids`: Subnets for VPC endpoint (conditional)
- `security_group_ids`: SGs for VPC endpoint (optional)
- `create_vpc_endpoint`: Create vs use existing

### IAM Configuration
- `create_iam_roles`: Admin mode (true) or power user mode (false)
- `lambda_api_role_arn`: Pre-created role ARN (power user)
- `lambda_authorizer_role_arn`: Pre-created role ARN (power user)
- `lambda_event_processor_role_arn`: Pre-created role ARN (power user)
- `api_gateway_authorizer_invocation_role_arn`: Pre-created role ARN (power user)

### Feature Flags
- `enable_s3_versioning`: Bucket versioning (default: true)
- `enable_eventbridge_metadata_extraction`: Event-driven processing (default: true)
- `enable_dlq`: Dead Letter Queue (default: true)
- `enable_api_gateway_logs`: CloudWatch logging (default: true)
- `enable_waf`: WAF protection (default: false)

## Conditional Logic Patterns

### Local Variable Computations

```hcl
# Determine which IAM roles to use
lambda_api_role_arn = var.create_iam_roles ? 
  aws_iam_role.lambda_api[0].arn : 
  var.lambda_api_role_arn

# Determine authentication method
use_api_key_auth = var.auth_method == "api_key"
use_cognito_auth = var.auth_method == "cognito"

# Select correct authorizer
authorizer_id = local.use_api_key_auth ? 
  aws_api_gateway_authorizer.api_key[0].id : 
  aws_api_gateway_authorizer.cognito[0].id

# Determine Cognito User Pool ARN
cognito_user_pool_arn = local.use_cognito_auth ? 
  (var.create_cognito_user_pool ? 
    aws_cognito_user_pool.main[0].arn : 
    var.cognito_user_pool_arn) : 
  null
```

### Resource Conditional Creation

```hcl
# Create only when using API key authentication
resource "aws_lambda_function" "authorizer" {
  count = local.use_api_key_auth ? 1 : 0
  # ...
}

# Create only when admin mode
resource "aws_iam_role" "lambda_api" {
  count = var.create_iam_roles ? 1 : 0
  # ...
}

# Create only when event processing enabled
resource "aws_cloudwatch_event_rule" "metadata_extraction" {
  count = var.enable_eventbridge_metadata_extraction ? 1 : 0
  # ...
}
```

## API Endpoint Catalog

### Public Endpoints (No Authentication)
- `GET /healthcheck` - Service health status

### Authenticated Endpoints
- `GET /documents` - List all documents with metadata
- `POST /documents` - Upload new document
- `GET /documents/{id}` - Retrieve specific document
- `PUT /documents/{id}` - Replace document content
- `DELETE /documents/{id}` - Delete document (soft delete)
- `POST /documents/{id}/archive` - Move to archive tier
- `POST /documents/{id}/restore` - Restore from archive
- `ANY /{proxy+}` - Catch-all proxy for extensibility

### CORS Support
All authenticated endpoints include OPTIONS method with appropriate headers for cross-origin requests.

## Lambda Function Details

### 1. API Handler (`api_handler`)
- **Handler**: `src.handlers.api.main.lambda_handler`
- **Memory**: 512 MB (configurable)
- **Timeout**: 30 seconds (configurable)
- **Environment Variables**:
  - `S3_BUCKET_NAME`: Document storage bucket
  - `DYNAMODB_TABLE_NAME`: Metadata table
  - `AWS_REGION`: Current region
  - `SECRETS_ARN`: API key secrets (for validation)
- **Permissions**: S3 (CRUD), DynamoDB (CRUD), Secrets Manager (read), EventBridge (put)

### 2. Authorizer (`authorizer`)
- **Conditional**: Only when `auth_method = "api_key"`
- **Handler**: `src.handlers.auth_validator.lambda_handler`
- **Memory**: 256 MB
- **Timeout**: 10 seconds
- **Environment Variables**:
  - `SECRETS_ARN`: API key secrets location
- **Permissions**: Secrets Manager (read)
- **Invocation**: Via API Gateway REQUEST authorizer

### 3. Event Processor (`event_processor`)
- **Conditional**: Only when `enable_eventbridge_metadata_extraction = true`
- **Handler**: `src.handlers.event_processor.lambda_handler`
- **Memory**: 512 MB (configurable)
- **Timeout**: 60 seconds
- **Environment Variables**:
  - `S3_BUCKET_NAME`: Document storage bucket
  - `DYNAMODB_TABLE_NAME`: Metadata table
  - `AWS_REGION`: Current region
- **Permissions**: S3 (read), DynamoDB (write)
- **Trigger**: EventBridge rule on S3 object creation

## Security Model

### Encryption
- **S3**: Server-side encryption (AES256) by default
- **DynamoDB**: Encryption at rest (AWS managed keys)
- **Secrets Manager**: KMS encryption for API keys
- **API Gateway**: TLS 1.2+ for all connections

### Access Control
- **S3 Bucket**: Public access blocked, IAM-based access only
- **API Gateway**: Authorization required (except healthcheck)
- **Lambda**: Least-privilege IAM roles
- **VPC Endpoint**: Security group restricts access to VPC CIDR

### Authentication Flows

**API Key Flow**:
1. Client includes API key in Authorization header
2. API Gateway invokes Lambda authorizer
3. Authorizer validates key against Secrets Manager
4. Returns IAM policy allowing/denying access
5. API Gateway caches policy (configurable)

**Cognito Flow**:
1. Client authenticates with Cognito User Pool
2. Receives JWT tokens (access, ID, refresh)
3. Includes access token in Authorization header
4. API Gateway validates JWT signature and expiration
5. Extracts user claims and allows/denies access

## Output Values

Critical outputs for downstream consumption:
- `api_gateway_endpoint`: Invoke URL for API
- `cognito_user_pool_id`: User pool identifier (if created)
- `cognito_app_client_id`: Client ID for authentication (if created)
- `cognito_domain`: Hosted UI URL (if domain created)
- `s3_bucket_name`: Document storage bucket
- `lambda_api_handler_arn`: Main API function ARN
- `vpc_endpoint_id`: Private API endpoint ID (if created)

## Best Practices for Code Modifications

### Adding New Variables
1. Add to `variables.tf` with type, description, default, validation
2. Update `locals.tf` if conditional logic needed
3. Reference in appropriate service .tf file
4. Add output in `outputs.tf` if user-facing
5. Document in README.md with example usage

### Adding New Resources
1. Place in appropriate service-specific .tf file
2. Use `${local.resource_prefix}` for naming
3. Add `local.common_tags` for cost tracking
4. Consider conditional creation with `count`
5. Add outputs for resource ARNs/IDs
6. Update README.md inputs/outputs tables

### Maintaining Compatibility
- Use `count` instead of `for_each` for conditional resources
- Provide sensible defaults for all optional variables
- Add validation rules for critical inputs
- Keep backwards compatibility when modifying variables
- Document breaking changes in CHANGELOG.md

## Testing Scenarios

Recommended test matrix:
1. **Basic Deployment**: Default settings, API key auth
2. **Admin Mode**: All features enabled, IAM creation
3. **Power User Mode**: Pre-created IAM roles
4. **Private API**: VPC endpoint with security group
5. **Cognito Auth**: Create new user pool
6. **Cognito Existing**: Use existing user pool
7. **Minimal**: Event processing disabled, no DLQ
8. **Multi-Region**: Two regions with same DynamoDB table

## Common Issues and Solutions

### Issue: "Error creating VPC endpoint"
**Cause**: Missing subnet IDs or VPC ID  
**Solution**: Verify `vpc_id` and `subnet_ids` are provided when `api_gateway_endpoint_type = "PRIVATE"` and `create_vpc_endpoint = true`

### Issue: "Cognito authorizer validation failed"
**Cause**: User pool ARN not provided or incorrect  
**Solution**: Set `cognito_user_pool_arn` when `auth_method = "cognito"` and `create_cognito_user_pool = false`

### Issue: "Lambda function has no permission to read from S3"
**Cause**: IAM role missing permissions  
**Solution**: Verify `create_iam_roles = true` or provide correct `lambda_api_role_arn` with S3 permissions

### Issue: "API Gateway returns 401 Unauthorized"
**Cause**: Authorizer misconfiguration  
**Solution**: Check `auth_method` matches deployment, verify API key in Secrets Manager or Cognito pool configuration

## Related Documentation

- **README.md**: User-facing module documentation with examples
- **IAM_POLICY_EXAMPLES.md**: Sample IAM policies for power user mode
- **kumocms-lambda-python/README.md**: Lambda function implementation details
- **kumocms.github.io**: Project website with architecture diagrams

## Code Quality Standards

✅ **Copyright headers** on all .tf files  
✅ **SPDX license identifiers** (MIT)  
✅ **Section comments** with context  
✅ **Consistent formatting** (2-space indent)  
✅ **Descriptive variable names**  
✅ **Input validation** for critical variables  
✅ **Common tags** on all resources  
✅ **Inline documentation** for complex logic  

---

**Assistant Role**: When working with this module, maintain the established patterns for conditional resources, comprehensive documentation, and flexible deployment modes. Prioritize backwards compatibility and clear user communication for any changes.
